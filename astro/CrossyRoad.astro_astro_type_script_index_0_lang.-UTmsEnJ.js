import*as r from"https://esm.sh/three";const M=-8,y=8,k=y-M+1,c=42;function A(){const n=window.innerWidth/window.innerHeight,t=n<1?300:300*n,o=n<1?300/n:300,i=new r.OrthographicCamera(t/-2,t/2,o/2,o/-2,100,900);return i.up.set(0,0,1),i.position.set(300,-300,300),i.lookAt(0,0,0),i}function g(e,n,t){const o=document.createElement("canvas");o.width=e,o.height=n;const i=o.getContext("2d");if(!i)throw new Error("Could not get 2D context");return i.fillStyle="#ffffff",i.fillRect(0,0,e,n),i.fillStyle="rgba(0,0,0,0.6)",t.forEach(a=>{i.fillRect(a.x,a.y,a.w,a.h)}),new r.CanvasTexture(o)}const O=g(40,80,[{x:0,y:10,w:30,h:60}]),U=g(40,80,[{x:10,y:10,w:30,h:60}]),F=g(110,40,[{x:10,y:0,w:50,h:30},{x:70,y:0,w:30,h:30}]),V=g(110,40,[{x:10,y:10,w:50,h:30},{x:70,y:10,w:30,h:30}]),H=g(30,30,[{x:5,y:0,w:10,h:30}]),j=g(25,30,[{x:15,y:5,w:10,h:10}]),q=g(25,30,[{x:15,y:15,w:10,h:10}]);function D(e,n,t){const o=new r.Group;o.position.x=e*c,n||(o.rotation.z=Math.PI);const i=new r.Mesh(new r.BoxGeometry(60,30,15),new r.MeshLambertMaterial({color:t,flatShading:!0}));i.position.z=12,i.castShadow=!0,i.receiveShadow=!0,o.add(i);const a=new r.Mesh(new r.BoxGeometry(33,24,12),[new r.MeshPhongMaterial({color:13421772,flatShading:!0,map:U}),new r.MeshPhongMaterial({color:13421772,flatShading:!0,map:O}),new r.MeshPhongMaterial({color:13421772,flatShading:!0,map:F}),new r.MeshPhongMaterial({color:13421772,flatShading:!0,map:V}),new r.MeshPhongMaterial({color:13421772,flatShading:!0}),new r.MeshPhongMaterial({color:13421772,flatShading:!0})]);a.position.x=-6,a.position.z=25.5,a.castShadow=!0,a.receiveShadow=!0,o.add(a);const s=S(18);o.add(s);const u=S(-18);return o.add(u),o}function X(){const e=new r.DirectionalLight;return e.position.set(-100,-100,200),e.up.set(0,0,1),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.up.set(0,0,1),e.shadow.camera.left=-400,e.shadow.camera.right=400,e.shadow.camera.top=400,e.shadow.camera.bottom=-400,e.shadow.camera.near=50,e.shadow.camera.far=400,e}function B(e){const n=new r.Group;n.position.y=e*c;const t=s=>new r.Mesh(new r.BoxGeometry(k*c,c,3),new r.MeshLambertMaterial({color:s})),o=t(12252245);o.receiveShadow=!0,n.add(o);const i=t(10078278);i.position.x=-17*c,n.add(i);const a=t(10078278);return a.position.x=k*c,n.add(a),n}const x=[],p=new r.Group;function Y(){x.length=0,p.remove(...p.children);for(let e=0;e>-10;e--){const n=B(e);p.add(n)}P()}function P(){const e=te(20),n=x.length;x.push(...e),e.forEach((t,o)=>{const i=n+o+1;if(t.type==="forest"){const a=B(i);t.trees.forEach(({tileIndex:s,height:u})=>{const v=Z(s,u);a.add(v)}),p.add(a)}if(t.type==="car"){const a=R(i);t.vehicles.forEach(s=>{const u=D(s.initialTileIndex,t.direction,s.color);s.ref=u,a.add(u)}),p.add(a)}if(t.type==="truck"){const a=R(i);t.vehicles.forEach(s=>{const u=_(s.initialTileIndex,t.direction,s.color);s.ref=u,a.add(u)}),p.add(a)}})}const h=Q();function Q(){const e=new r.Group,n=new r.Mesh(new r.BoxGeometry(15,15,20),new r.MeshLambertMaterial({color:"white",flatShading:!0}));n.position.z=10,n.castShadow=!0,n.receiveShadow=!0,e.add(n);const t=new r.Mesh(new r.BoxGeometry(2,4,2),new r.MeshLambertMaterial({color:15753626,flatShading:!0}));t.position.z=21,t.castShadow=!0,t.receiveShadow=!0,e.add(t);const o=new r.Group;return o.add(e),o}const d={currentRow:0,currentTile:0},l=[];function J(){h.position.x=0,h.position.y=0,h.children[0].position.z=0,d.currentRow=0,d.currentTile=0,l.length=0}function w(e){ee({rowIndex:d.currentRow,tileIndex:d.currentTile},[...l,e])&&l.push(e)}function K(){const e=l.shift();e==="forward"&&(d.currentRow+=1),e==="backward"&&(d.currentRow-=1),e==="left"&&(d.currentTile-=1),e==="right"&&(d.currentTile+=1),d.currentRow>x.length-10&&P();const n=document.getElementById("score");n&&(n.innerText=d.currentRow.toString())}function N(){const e=document.querySelector("canvas.game");if(!e)throw new Error("Canvas not found");const n=new r.WebGLRenderer({alpha:!0,antialias:!0,canvas:e});return n.setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth,window.innerHeight),n.shadowMap.enabled=!0,n}function R(e){const n=new r.Group;n.position.y=e*c;const t=s=>new r.Mesh(new r.PlaneGeometry(k*c,c),new r.MeshLambertMaterial({color:s})),o=t(4541017);o.receiveShadow=!0,n.add(o);const i=t(3751241);i.position.x=-17*c,n.add(i);const a=t(3751241);return a.position.x=k*c,n.add(a),n}function Z(e,n){const t=new r.Group;t.position.x=e*c;const o=new r.Mesh(new r.BoxGeometry(15,15,20),new r.MeshLambertMaterial({color:5056806,flatShading:!0}));o.position.z=10,t.add(o);const i=new r.Mesh(new r.BoxGeometry(30,30,n),new r.MeshLambertMaterial({color:8036893,flatShading:!0}));return i.position.z=n/2+20,i.castShadow=!0,i.receiveShadow=!0,t.add(i),t}function _(e,n,t){const o=new r.Group;o.position.x=e*c,n||(o.rotation.z=Math.PI);const i=new r.Mesh(new r.BoxGeometry(70,35,35),new r.MeshLambertMaterial({color:11847420,flatShading:!0}));i.position.x=-15,i.position.z=25,i.castShadow=!0,i.receiveShadow=!0,o.add(i);const a=new r.Mesh(new r.BoxGeometry(30,30,30),[new r.MeshLambertMaterial({color:t,flatShading:!0,map:H}),new r.MeshLambertMaterial({color:t,flatShading:!0}),new r.MeshLambertMaterial({color:t,flatShading:!0,map:q}),new r.MeshLambertMaterial({color:t,flatShading:!0,map:j}),new r.MeshPhongMaterial({color:t,flatShading:!0}),new r.MeshPhongMaterial({color:t,flatShading:!0})]);a.position.x=35,a.position.z=20,a.castShadow=!0,a.receiveShadow=!0,o.add(a);const s=S(37);o.add(s);const u=S(5);o.add(u);const v=S(-35);return o.add(v),o}function S(e){const n=new r.Mesh(new r.BoxGeometry(12,33,12),new r.MeshLambertMaterial({color:3355443,flatShading:!0}));return n.position.x=e,n.position.z=6,n}function $(e,n){return n.reduce((t,o)=>o==="forward"?{rowIndex:t.rowIndex+1,tileIndex:t.tileIndex}:o==="backward"?{rowIndex:t.rowIndex-1,tileIndex:t.tileIndex}:o==="left"?{rowIndex:t.rowIndex,tileIndex:t.tileIndex-1}:o==="right"?{rowIndex:t.rowIndex,tileIndex:t.tileIndex+1}:t,e)}function ee(e,n){const t=$(e,n);if(t.rowIndex===-1||t.tileIndex===M-1||t.tileIndex===y+1)return!1;const o=x[t.rowIndex-1];return!(o&&o.type==="forest"&&o.trees.some(i=>i.tileIndex===t.tileIndex))}function te(e){const n=[];for(let t=0;t<e;t++){const o=ne();n.push(o)}return n}function ne(){const e=f(["car","truck","forest"]);return e==="car"?re():e==="truck"?ie():oe()}function f(e){return e[Math.floor(Math.random()*e.length)]}function oe(){const e=new Set;return{type:"forest",trees:Array.from({length:4},()=>{let t;do t=r.MathUtils.randInt(M,y);while(e.has(t));e.add(t);const o=f([20,45,60]);return{tileIndex:t,height:o}})}}function re(){const e=f([!0,!1]),n=f([125,156,188]),t=new Set,o=Array.from({length:3},()=>{let i;do i=r.MathUtils.randInt(M,y);while(t.has(i));t.add(i-1),t.add(i),t.add(i+1);const a=f([10822947,12432952,7909707]);return{initialTileIndex:i,color:a}});return{type:"car",direction:e,speed:n,vehicles:o}}function ie(){const e=f([!0,!1]),n=f([125,156,188]),t=new Set,o=Array.from({length:2},()=>{let i;do i=r.MathUtils.randInt(M,y);while(t.has(i));t.add(i-2),t.add(i-1),t.add(i),t.add(i+1),t.add(i+2);const a=f([10822947,12432952,7909707]);return{initialTileIndex:i,color:a}});return{type:"truck",direction:e,speed:n,vehicles:o}}const I=new r.Clock(!1);function ae(){if(!l.length)return;I.running||I.start();const n=Math.min(1,I.getElapsedTime()/.2);ce(n),se(n),n>=1&&(K(),I.stop())}function ce(e){const n=d.currentTile*c,t=d.currentRow*c;let o=n,i=t;l[0]==="left"&&(o-=c),l[0]==="right"&&(o+=c),l[0]==="forward"&&(i+=c),l[0]==="backward"&&(i-=c),h.position.x=r.MathUtils.lerp(n,o,e),h.position.y=r.MathUtils.lerp(t,i,e),h.children[0].position.z=Math.sin(e*Math.PI)*8}function se(e){let n=0;l[0]=="forward"&&(n=0),l[0]=="left"&&(n=Math.PI/2),l[0]=="right"&&(n=-Math.PI/2),l[0]=="backward"&&(n=Math.PI),h.children[0].rotation.z=r.MathUtils.lerp(h.children[0].rotation.z,n,e)}const de=new r.Clock;function le(){const e=de.getDelta();x.forEach(n=>{if(n.type==="car"||n.type==="truck"){const t=(M-2)*c,o=(y+2)*c;n.vehicles.forEach(({ref:i})=>{if(!i)throw Error("Vehicle reference is missing");n.direction?i.position.x=i.position.x>o?t:i.position.x+n.speed*e:i.position.x=i.position.x<t?o:i.position.x-n.speed*e})}})}document.getElementById("forward")?.addEventListener("click",()=>w("forward"));document.getElementById("backward")?.addEventListener("click",()=>w("backward"));document.getElementById("left")?.addEventListener("click",()=>w("left"));document.getElementById("right")?.addEventListener("click",()=>w("right"));window.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),w("forward")):e.key==="ArrowDown"?(e.preventDefault(),w("backward")):e.key==="ArrowLeft"?(e.preventDefault(),w("left")):e.key==="ArrowRight"&&(e.preventDefault(),w("right"))});function he(){const e=x[d.currentRow-1];if(e&&(e.type==="car"||e.type==="truck")){const n=new r.Box3;n.setFromObject(h),e.vehicles.forEach(({ref:t})=>{if(!t)throw Error("Vehicle reference is missing");const o=new r.Box3;if(o.setFromObject(t),n.intersectsBox(o)){if(!b||!z)return;b.style.visibility="visible",z.innerText=d.currentRow.toString()}})}}const T=new r.Scene;T.add(h);T.add(p);const ue=new r.AmbientLight;T.add(ue);const G=X();G.target=h;h.add(G);const m=A();h.add(m);const E=document.getElementById("score"),b=document.getElementById("result-container"),z=document.getElementById("final-score");C();document.querySelector("#retry")?.addEventListener("click",C);function C(){J(),Y(),E&&(E.innerText="0"),b&&(b.style.visibility="hidden")}const L=N();L.setAnimationLoop(we);function W(){const e=window.innerWidth,n=window.innerHeight;L.setSize(e,n);const t=300,o=e/n;m.left=(o<1?t:t*o)/-2,m.right=(o<1?t:t*o)/2,m.top=(o<1?t/o:t)/2,m.bottom=(o<1?t/o:t)/-2,m.updateProjectionMatrix()}window.addEventListener("resize",W);W();function we(){le(),ae(),he(),L.render(T,m)}export{H as truckFrontTexture,q as truckLeftSideTexture,j as truckRightSideTexture};
